<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Registro de Restaurante</title>
</head>

<body>

  <h1>LOCALY</h1>
  <h2>Reg칤strate y anuncia tu</h2>
  <h2>Restaurante</h2>

  <form id="registroForm">
    <label for="usuario">Nombre de usuario</label><br>
    <input type="text" id="usuario" name="usuario" required><br><br>

    <label for="contrasena">Contrase침a</label><br>
    <input type="password" id="contrasena" name="contrasena" required><br><br>

    <label for="correo">Correo electr칩nico</label><br>
    <input type="email" id="correo" name="correo" required><br><br>

    <label for="telefono">N칰mero de tel칠fono</label><br>
    <input type="tel" id="telefono" name="telefono" required><br><br>

    <p>Tama침o del local / restaurante</p>

    <input type="radio" id="pequeno" name="price_id" value="price_1Rdd4vKfdCp6fARc60UNjgrv" required>
    <label for="pequeno">Peque침o (Fijo, sin local establecido).</label><br>

    <input type="radio" id="mediano" name="price_id" value="price_1Rdd45KfdCp6fARccYqz2ScS">
    <label for="mediano">Mediano (Con local establecido, pero no m치s de 4 mesas para consumir dentro).</label><br>

    <input type="radio" id="grande" name="price_id" value="price_1RdbsiKfdCp6fARcdlSycYcd">
    <label for="grande">Grande (Con m치s de 6 mesas para consumir dentro).</label><br><br>

    <button type="submit">Reg칤strate</button>
  </form>

  <script>
    const form = document.getElementById('registroForm');

    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      const usuario = document.getElementById('usuario').value;
      const correo = document.getElementById('correo').value;

      // Validar correo y usuario
      try {
        const verif = await fetch('/api/verificar-negocio', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ correo, usuario })
        });

        const result = await verif.json();

        if (result.correoExiste) {
          alert("El correo ya est치 registrado.");
          return;
        }

        if (result.usuarioExiste) {
          alert("El nombre de usuario ya est치 en uso.");
          return;
        }

      } catch (err) {
        console.error("Error al verificar:", err);
        alert("No se pudo validar el correo o usuario.");
        return;
      }

      /*
      * Vulnerabilidad de alta prioridad:
      *     *No a침adir los datos directamente de la interfaz sin antes validarlos*
      */
      // Enviar datos a Stripe
      const datos = {
        usuario,
        contrasena: document.getElementById('contrasena').value,
        correo,
        telefono: document.getElementById('telefono').value,
        price_id: document.querySelector('input[name="price_id"]:checked')?.value,
        tipo: "negocio" // 游녣 Aqu칤 se indica que es negocio
      };

      try {
        const res = await fetch('/api/restaurante/crear-sesion-pago', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(datos)
        });

        const pago = await res.json();
        if (pago.url) {
          window.location.href = pago.url;
        } else {
          alert("Hubo un problema al iniciar el pago.");
        }
      } catch (err) {
        console.error("Error al iniciar pago:", err);
        alert("Error de red.");
      }
    });
  </script>

</body>
</html>
